<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>customer Management </title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- axios.get(MY_SERVER).then(res) -->
</head>

<body>
  <div>
    <a href="index.html"><button>home page</button></a>
    <a href="login.html"><button>login</button></a>
    <a href="signup.html"><button>signup</button></a>
    <a href="return_book.html"><button>return_book</button></a>
    <a href="books.html"><button>books</button></a>
    <a href="customers.html"><button>customers</button></a>
    <!-- <a href=""><button></button></a> -->
  </div>
  <hr>
  <h1>Library Management System</h1>

  <div id="messeges"></div>
  <form id="signupForm" action="/signup" ,method="post"></form>
  customer_name <input type="text" id="name"><br>
  customer city: <input type="text" id="city"><br>
  customer age: <input type="number " id="age"><br>
  <label for="email">Email:</label>
  <input type="email" name="email" id="email" required><br>
  <label for="password">Password:</label>
  <input type="password" name="password" id="password" required><br>
  <!-- Use a button with type="button" to handle click event -->
  <button type="button" onclick="get_customers()">print customers</button>
  <a href="signup.html "><button>signup</button></a>
  </form>

  <div id="display"></div>


  <script>
    let customer_to_edit = ""
    const MY_SERVER = "http://127.0.0.1:5000"

    const get_customers = () => {
      axios.get(MY_SERVER + "/customers")
        .then(function (response) {
          display.innerHTML = `<h1>curremt customers</h1>`
          response.data.forEach(customer => {
            display.innerHTML += `<div>id: ${customer.id} 
         ,name: ${customer.customer_name}
         ,email: ${customer.email}
         ,city: ${customer.city}
         ,age: ${customer.age}
         <div>
          <button onclick ="edit_customer('${customer.customer_name}')">edit</button>
          <button onclick ="delete_customer('${customer.customer_name}')">delte</button>
          </div>
         </div>
         `})
        })
    }


    const search_customer = () => {
      payload = { "customer_name": customer_name.value }
      display.innerHTML = ""
      axios.post(MY_SERVER + "/find_customer", payload)
        .then(result => {
          result.data.forEach(res => {

            display.innerHTML += `
                        customer id: ${res.customer_id}
                        customer name: ${res.customer_name},
                        age: ${res.age}   
                        from: ${res.city},
                        <div>
                            <button onclick = "edit_customer(${res.customer_id})">press here to edit</button>
                            <button onclick = "delete_customer_by_id(${res.customer_id})">press here to delete</button>
                            </div>    
                            `
          });

        })
    }

    const edit_customer = (customer_id) => {
      FormData = {
        "customer_id": customer_id,
        "new_name": customer_name.value,
        "new_city": city.value,
        "new_age": age.value,
        "new_password": customer_password.value
      }
      axios.put(MY_SERVER + "/edit_customer", FormData)
        .then(res => {
          res.data["messege"]
        })
    }



    const delete_customer_by_id = (customerId) => {
      // Check if the customer has associated loans
      axios.get(`${MY_SERVER}/delete_customer_by_id/${customerId}`)
        .then(response => {
          // If there are associated loans, ask for confirmation
          if (response.data.options) {
            console.log("im in options");
            handleDeleteConfirmation(customerId);
          } else {
            // If no associated loans, proceed with deletion
            console.log("no options given");
            deletecustomerWithLoans(customerId);
          }
        })
        .catch(error => {
          console.error(error.response.data);
          // Handle errors or display error messages to the user
        });
    };



    const cancelcustomerRemoval = () => {
      // Clear the confirmation message
      document.getElementById("confirmation").innerHTML = "";
    };



    const deletecustomerWithLoans = (customerId) => {
      document.getElementById("confirmation").innerHTML = "";
      // Send a DELETE request to the backend with the customerId
      axios.delete(`${MY_SERVER}/delete_customer_by_id/${customerId}`)
        .then(response => {
          // Display the server response
          confirmation.innerHTML += response.data.messege
          // You can perform additional actions or UI updates here
        })
        .catch(error => {
          console.error(error.response.data);
          // Handle errors or display error messages to the user
        });

      // Clear the confirmation message
    };



    const handleDeleteConfirmation = (customerId) => {
      // Display a confirmation message to the user
      const confirmationMessage = `
        <div>
            There are active loans on this customer. Do you want to remove it and delete the associated loans?
            <button onclick="deletecustomerWithLoans(${customerId})">Yes</button>
            <button onclick="cancelcustomerRemoval()">No</button>
        </div>
    `;
      document.getElementById("confirmation").innerHTML = confirmationMessage;
    };



    get_customers()
  </script>

  <body>

</html>